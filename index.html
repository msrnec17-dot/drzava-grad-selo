<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr≈æava Grad Selo - Multiplayer</title>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <style>
        /* isti stilovi kao prije */
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f0f8ff; }
        .container { display: flex; gap: 20px; height: 80vh; }
        .sidebar { width: 300px; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .game-area { flex: 1; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-y: auto; }
        .player-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 20px 0; }
        .player-card { border: 2px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; }
        .player-active { border-color: #4CAF50; background: #e8f5e8; }
        .input-group { margin: 10px 0; }
        input, button { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        button { background: #2196F3; color: white; border: none; cursor: pointer; }
        button:hover { background: #1976D2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .answers-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .answer-card { border: 2px solid #ddd; border-radius: 8px; padding: 15px; position: relative; }
        .answer-voted { border-color: #4CAF50; background: #e8f5e8; }
        .vote-btns { margin-top: 10px; display: flex; gap: 5px; }
        .vote-btn { flex: 1; padding: 5px; font-size: 14px; }
        .countdown { font-size: 24px; font-weight: bold; text-align: center; margin: 20px 0; color: #FF5722; }
        .scores { margin-top: 20px; }
        .score-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
        .round-info { text-align: center; font-size: 20px; margin-bottom: 20px; color: #333; }
        .hidden { display: none; }
        h1, h2 { color: #2196F3; text-align: center; }
        .debug { background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üá≠üá∑ Dr≈æava ‚Ä¢ Grad ‚Ä¢ Selo üá≠üá∑</h1>
    
    <div class="debug" id="debugLog"></div>
    
    <div class="container">
        <div class="sidebar">
            <div class="input-group">
                <input type="text" id="playerName" placeholder="Tvoje ime" maxlength="20">
                <button onclick="joinGame()">Pridru≈æi se igri</button>
            </div>
            
            <div id="gameInfo" class="hidden">
                <h3>Trenutna runda: <span id="currentRound">1</span>/7</h3>
                <div class="round-info">
                    <div id="currentLetter" style="font-size: 48px; font-weight: bold; color: #FF5722;">A</div>
                    <div>Slovo: <span id="letterDisplay">-</span></div>
                </div>
                
                <div id="phaseDisplay">Priprema igre...</div>
                <div class="countdown" id="countdown" style="display:none;"></div>
                
                <div class="scores">
                    <h4>Bodovi igraƒça:</h4>
                    <div id="scoresList"></div>
                </div>
            </div>
        </div>
        
        <div class="game-area">
            <div id="answerSection">
                <div class="input-group">
                    <input type="text" id="drzavaInput" placeholder="Dr≈æava na slovo..." disabled>
                    <input type="text" id="gradInput" placeholder="Grad na slovo..." disabled>
                    <input type="text" id="seloInput" placeholder="Selo na slovo..." disabled>
                    <button id="submitAnswerBtn" onclick="submitAnswer()" disabled>Po≈°alji odgovore</button>
                </div>
            </div>
            
            <div id="votingSection" class="hidden">
                <h3>Glasaj za odgovore (30s)</h3>
                <div class="answers-grid" id="answersGrid"></div>
            </div>
            
            <div id="resultsSection" class="hidden">
                <h3>Rezultati runde</h3>
                <div id="roundResults"></div>
            </div>
        </div>
    </div>

    <script>
        // TEST Firebase config - zamijeni sa SVOJIM
      const firebaseConfig = {
  apiKey: "AIzaSyAwqBgH3OOfC74k21fln-xd5Q1E6w2gptY",
  authDomain: "drzava-grad-selo-8d986.firebaseapp.com",
  databaseURL: "https://drzava-grad-selo-8d986-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "drzava-grad-selo-8d986",
  storageBucket: "drzava-grad-selo-8d986.firebasestorage.app",
  messagingSenderId: "499006072662",
  appId: "1:499006072662:web:3001f6700f0268df1b58f7"
};
        
        // Inicijalizacija
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let currentUser = null;
        let gameState = { round: 1, letter: 'A', phase: 'waiting', votingEnd: null, lastUpdate: Date.now() };
        let playerAnswers = {};
        let unsubscribeListeners = [];
        let myAnswers = { drzava: '', grad: '', selo: '' };

        function log(msg) {
            const logEl = document.getElementById('debugLog');
            logEl.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }

        // Pridru≈æi se igri - POPRAVAK
        async function joinGame() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) return alert('Unesi ime!');
            
            try {
                currentUser = { name, id: `player_${Date.now()}_${Math.random().toString(36).substr(2, 9)}` };
                log(`‚úÖ Pridru≈æio si se kao: ${currentUser.name} (${currentUser.id})`);
                
                // Spremi igraƒça
                await db.collection('dgs_game').doc('players').collection('players').doc(currentUser.id).set({
                    name: currentUser.name,
                    points: 0,
                    joined: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                document.getElementById('gameInfo').classList.remove('hidden');
                document.getElementById('playerName').disabled = true;
                
                // Inicijaliziraj stanje igre
                await db.collection('dgs_game').doc('state').set(gameState, { merge: true });
                
                listenToGame();
                log('üöÄ Svi listeneri aktivni');
                
            } catch(error) {
                log(`‚ùå Gre≈°ka: ${error.message}`);
                alert('Gre≈°ka s Firebase-om! Provjeri config.');
            }
        }

        // Slu≈°aj promjene - POPRAVAK
        function listenToGame() {
            // State listener
            const stateUnsub = db.collection('dgs_game').doc('state').onSnapshot(
                doc => {
                    if (doc.exists) {
                        gameState = { ...doc.data(), id: doc.id, lastUpdate: Date.now() };
                        log(`üìä State: runda ${gameState.round}, faza ${gameState.phase}`);
                        updateUI();
                    }
                },
                err => log(`State error: ${err}`)
            );
            unsubscribeListeners.push(stateUnsub);

            // Players listener
            const playersUnsub = db.collection('dgs_game').doc('players').collection('players').onSnapshot(
                snapshot => {
                    const players = {};
                    snapshot.forEach(doc => players[doc.id] = doc.data());
                    updatePlayersList(players);
                },
                err => log(`Players error: ${err}`)
            );
            unsubscribeListeners.push(playersUnsub);

            // Answers listener za trenutnu rundu
            const answersUnsub = db.collection('dgs_game').doc('answers')
                .collection(`round_${gameState.round}`).onSnapshot(
                snapshot => {
                    const answers = {};
                    snapshot.forEach(doc => answers[doc.id] = doc.data());
                    playerAnswers = answers;
                    if (gameState.phase === 'voting') updateAnswersDisplay();
                },
                err => log(`Answers error: ${err}`)
            );
            unsubscribeListeners.push(answersUnsub);
        }

        // Po≈°alji odgovore - POPRAVLJENO
        async function submitAnswer() {
            if (!currentUser) return log('‚ùå Nisi pridru≈æen!');
            
            myAnswers = {
                drzava: document.getElementById('drzavaInput').value.trim().toLowerCase(),
                grad: document.getElementById('gradInput').value.trim().toLowerCase(),
                selo: document.getElementById('seloInput').value.trim().toLowerCase()
            };
            
            if (!myAnswers.drzava || !myAnswers.grad || !myAnswers.selo) {
                return alert('Svi odgovori su obvezni!');
            }
            
            try {
                await db.collection('dgs_game').doc('answers')
                    .collection(`round_${gameState.round}`)
                    .doc(currentUser.id)
                    .set({
                        player: currentUser.name,
                        drzava: myAnswers.drzava,
                        grad: myAnswers.grad,
                        selo: myAnswers.selo,
                        votes: {},
                        submitted: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                
                log(`‚úÖ Odgovori poslanI: ${JSON.stringify(myAnswers)}`);
                document.getElementById('drzavaInput').value = '';
                document.getElementById('gradInput').value = '';
                document.getElementById('seloInput').value = '';
                
            } catch(error) {
                log(`‚ùå Submit error: ${error.message}`);
            }
        }

        // Ostale funkcije (updateUI, vote, endVoting...) ostaju iste kao prije
        function updateUI() {
            document.getElementById('currentRound').textContent = gameState.round;
            document.getElementById('letterDisplay').textContent = gameState.letter;
            document.getElementById('currentLetter').textContent = gameState.letter;
            
            const phases = {
                'waiting': { title: 'ƒåekamo igraƒçe...', show: 'answer' },
                'answering': { title: 'Pi≈°i odgovore (30s)', show: 'answer' },
                'voting': { title: 'Glasaj (30s)', show: 'voting' },
                'results': { title: 'Rezultati...', show: 'results' }
            };
            
            const phase = phases[gameState.phase] || phases.waiting;
            document.getElementById('phaseDisplay').textContent = phase.title;
            
            document.getElementById('answerSection').classList.toggle('hidden', phase.show !== 'answer');
            document.getElementById('votingSection').classList.toggle('hidden', phase.show !== 'voting');
            document.getElementById('resultsSection').classList.toggle('hidden', phase.show !== 'results');
            
            updateInputs();
            updateCountdown();
        }

        function updateInputs() {
            const inputs = ['drzavaInput', 'gradInput', 'seloInput'];
            const btn = document.getElementById('submitAnswerBtn');
            
            const enabled = gameState.phase === 'answering';
            inputs.forEach(id => {
                const input = document.getElementById(id);
                input.disabled = !enabled;
                if (enabled) input.placeholder = input.placeholder.split('...')[0] + ` ${gameState.letter}`;
            });
            btn.disabled = !enabled;
        }

        // Automatski start answering nakon 5s
        setInterval(async () => {
            if (gameState.phase === 'waiting' && Date.now() - (gameState.lastUpdate || 0) > 5000) {
                gameState.phase = 'answering';
                gameState.votingEnd = Date.now() + 30000;
                await db.collection('dgs_game').doc('state').set(gameState);
                log('‚ñ∂Ô∏è Poƒçinje answering faza');
            }
        }, 2000);

        setInterval(updateCountdown, 1000);
        
        log('üéÆ Igra uƒçitana - unesi Firebase config i testiraj!');
    </script>
</body>
</html>
