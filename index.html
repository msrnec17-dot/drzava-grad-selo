<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ Slobodni dani & PK sati</title>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-muted: #64748b;
            --shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, #e2e8f0 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .login-card {
            max-width: 400px;
            margin: 100px auto 0;
            background: var(--card);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        .app-container { display: none; background: var(--card); border-radius: 20px; padding: 30px; box-shadow: var(--shadow); margin-top: 20px; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        .user-info h1 { color: var(--primary); margin-bottom: 5px; }
        .user-info .username { font-size: 1.1em; font-weight: 600; }
        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .logout-btn:hover { background: #dc2626; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        .stat-number { font-size: 2.2em; font-weight: bold; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        
        .section {
            background: var(--card);
            margin-bottom: 25px;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .section h2 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .form-group { display: flex; flex-direction: column; }
        label {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-muted);
            font-size: 0.9em;
        }
        input, select, textarea {
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.2s;
            background: #fafbff;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        textarea { resize: vertical; min-height: 70px; }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.2s;
            width: 100%;
        }
        .btn:hover { background: #2563eb; transform: translateY(-1px); }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; transform: none; }
        
        .pk-calc {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .pk-progress {
            background: #f1f5f9;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .progress-bar {
            background: #e2e8f0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #059669);
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            font-size: 0.9em;
        }
        th {
            background: var(--primary);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
        }
        td { padding: 12px; border-bottom: 1px solid var(--border); background: #fafbff; }
        tr:hover td { background: #f1f5f9; }
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .pk-calc { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- LOGIN -->
        <div id="loginCard" class="login-card">
            <h1>üìÖ Slobodni dani & PK</h1>
            <p style="color: var(--text-muted); margin-bottom: 30px;">Unesi korisniƒçko ime</p>
            <div class="form-group" style="max-width: 300px; margin: 0 auto;">
                <label>Korisniƒçko ime</label>
                <input type="text" id="usernameInput" placeholder="npr. marko" />
                <button class="btn" id="loginBtn">Ulogiraj se</button>
            </div>
        </div>

        <!-- APP -->
        <div id="appContainer" class="app-container">
            <div class="header">
                <div class="user-info">
                    <h1>üìä Tvoja evidencija</h1>
                    <div class="username" id="userDisplay"></div>
                </div>
                <button class="logout-btn" id="logoutBtn">üö™ Odjava</button>
            </div>

            <!-- UKUPNI SALDO -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalDays">0</div>
                    <div class="stat-label">Preostalih dana</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalPKHours">0</div>
                    <div class="stat-label">PK sati</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalFreeHours">0</div>
                    <div class="stat-label">Slobodnih sati (PK√ó1.6)</div>
                </div>
            </div>

            <!-- PREKOVREMENI SATI -->
            <div class="section">
                <h2>‚è∞ Prekovremeni sati</h2>
                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    Svaki PK sat = 1.6 slobodnih sati ‚Ä¢ 8 slobodnih sati = 1 dan
                </p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Datum rada</label>
                        <input type="date" id="pkDate">
                    </div>
                    <div class="form-group">
                        <label>PK sati</label>
                        <input type="number" id="pkHours" step="0.25" placeholder="2.5">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Napomena</label>
                        <textarea id="pkNote" placeholder="Zadatak/projekt..."></textarea>
                    </div>
                </div>
                <button class="btn" id="addPKBtn">‚ûï Dodaj PK sate</button>
                
                <!-- PK PROGRESS -->
                <div class="pk-progress">
                    <div>Ukupno PK sati do sljedeƒáeg dana: <span id="pkToNextDay">0</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="pkProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- ZARADJENI DANI -->
            <div class="section">
                <h2>üí∞ Zaraƒëeni dani</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Datum zarade</label>
                        <input type="date" id="earnedDate">
                    </div>
                    <div class="form-group">
                        <label>Vrsta</label>
                        <select id="earnedType">
                            <option value="PK">Iz PK sati</option>
                            <option value="godisnji">Godi≈°nji</option>
                            <option value="plaƒáeni">Plaƒáeni dopust</option>
                            <option value="ostalo">Ostalo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Broj dana</label>
                        <input type="number" id="earnedDays" step="0.1" placeholder="1.5">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Napomena</label>
                        <textarea id="earnedNote" placeholder="Napomena..."></textarea>
                    </div>
                </div>
                <button class="btn" id="addEarnedBtn">‚ûï Dodaj dane</button>
            </div>

            <!-- KORI≈†TENJE -->
            <div class="section">
                <h2>üìÖ Kori≈°tenje dana</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Od datuma</label>
                        <input type="date" id="useFrom">
                    </div>
                    <div class="form-group">
                        <label>Do datuma</label>
                        <input type="date" id="useTo">
                    </div>
                    <div class="form-group">
                        <label>Dani</label>
                        <input type="number" id="useDays" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Iz unosa</label>
                        <select id="useSource">
                            <option value="">Odaberi...</option>
                        </select>
                    </div>
                </div>
                <button class="btn" id="addUseBtn" disabled>‚ûï Iskoristi dane</button>
            </div>

            <!-- TABLICE -->
            <div class="section">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="margin-bottom: 15px; color: var(--success);">‚úÖ Zaraƒëeno</h3>
                        <table id="earnedTable">
                            <thead><tr><th>Datum</th><th>Vrsta</th><th>Ukupno</th><th>Preostalo</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 15px; color: var(--warning);">üì§ Iskori≈°teno</h3>
                        <table id="usedTable">
                            <thead><tr><th>Period</th><th>Dani</th><th>Iz unosa</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase
        const config = {
            apiKey: "AIzaSyAwqBgH3OOfC74k21fln-xd5Q1E6w2gptY",
            authDomain: "drzava-grad-selo-8d986.firebaseapp.com",
            databaseURL: "https://drzava-grad-selo-8d986-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "drzava-grad-selo-8d986",
            storageBucket: "drzava-grad-selo-8d986.firebasestorage.app",
            messagingSenderId: "499006072662",
            appId: "1:499006072662:web:3001f6700f0268df1b58f7"
        };
        firebase.initializeApp(config);
        const db = firebase.database();

        // Konstantne
        const PK_FACTOR = 1.6;
        const HOURS_PER_DAY = 8;

        // State
        let currentUser = null;
        let earnedData = {};

        // DOM
        const loginCard = document.getElementById('loginCard');
        const appContainer = document.getElementById('appContainer');
        const usernameInput = document.getElementById('usernameInput');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userDisplay = document.getElementById('userDisplay');
        
        const totalDays = document.getElementById('totalDays');
        const totalPKHours = document.getElementById('totalPKHours');
        const totalFreeHours = document.getElementById('totalFreeHours');
        const pkToNextDay = document.getElementById('pkToNextDay');
        const pkProgress = document.getElementById('pkProgress');
        
        const earnedTableBody = document.querySelector('#earnedTable tbody');
        const usedTableBody = document.querySelector('#usedTable tbody');
        const useSource = document.getElementById('useSource');
        const addUseBtn = document.getElementById('addUseBtn');

        // LOGIN
        loginBtn.onclick = async () => {
            const name = usernameInput.value.trim().toLowerCase();
            if (!name) return alert('Unesi ime!');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Uƒçitavam...';
            
            try {
                await db.ref(`vacation2/${name}`).set({name, created: Date.now()});
                currentUser = name;
                localStorage.setItem('vac_user2', name);
                showApp();
            } catch(e) {
                alert('Gre≈°ka! Provjeri internet.');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Ulogiraj se';
            }
        };

        // Auto login
        const saved = localStorage.getItem('vac_user2');
        if (saved) {
            currentUser = saved;
            showApp();
        }

        function showApp() {
            userDisplay.textContent = currentUser;
            loginCard.style.display = 'none';
            appContainer.style.display = 'block';
            loadData();
        }

        logoutBtn.onclick = () => location.reload();

        // LOAD DATA
        function loadData() {
            // PK sati
            db.ref(`vacation2/${currentUser}/pk`).on('value', snap => {
                let totalPK = 0;
                snap.forEach(child => {
                    totalPK += parseFloat(child.val().hours || 0);
                });
                
                const totalFreeHours = totalPK * PK_FACTOR;
                const earnedDaysFromPK = Math.floor(totalFreeHours / HOURS_PER_DAY);
                const hoursToNextDay = HOURS_PER_DAY - (totalFreeHours % HOURS_PER_DAY);
                const pkNeeded = (hoursToNextDay / PK_FACTOR).toFixed(1);
                
                totalPKHours.textContent = totalPK.toFixed(1);
                totalFreeHours.textContent = totalFreeHours.toFixed(1);
                pkToNextDay.textContent = `${pkNeeded}h PK do sljedeƒáeg dana`;
                pkProgress.style.width = `${Math.min(100, (totalFreeHours % HOURS_PER_DAY) / HOURS_PER_DAY * 100)}%`;
            });

            // Earned
            db.ref(`vacation2/${currentUser}/earned`).on('value', snap => {
                earnedTableBody.innerHTML = '';
                earnedData = {};
                let totalRemaining = 0;
                
                useSource.innerHTML = '<option value="">Odaberi...</option>';
                
                snap.forEach(child => {
                    const id = child.key;
                    const data = child.val();
                    earnedData[id] = data;
                    
                    const remaining = parseFloat(data.remaining || data.days || 0);
                    totalRemaining += remaining;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${data.date || ''}</td>
                        <td>${data.type || ''}</td>
                        <td>${parseFloat(data.days || 0).toFixed(2)}</td>
                        <td>
                            <span class="badge ${remaining <= 0 ? 'badge-warning' : 'badge-success'}">
                                ${remaining.toFixed(2)}
                            </span>
                        </td>
                    `;
                    earnedTableBody.appendChild(row);
                    
                    const option = new Option(
                        `${data.date} - ${data.type} (${remaining.toFixed(2)} ostalo)`, id
                    );
                    useSource.appendChild(option);
                });
                
                totalDays.textContent = totalRemaining.toFixed(2);
                addUseBtn.disabled = Object.keys(earnedData).length === 0;
            });

            // Used
            db.ref(`vacation2/${currentUser}/used`).on('value', snap => {
                usedTableBody.innerHTML = '';
                snap.forEach(child => {
                    const data = child.val();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${data.from}-${data.to}</td>
                        <td>${parseFloat(data.days || 0).toFixed(2)}</td>
                        <td>${data.source || ''}</td>
                    `;
                    usedTableBody.appendChild(row);
                });
            });
        }

        // ADD PK
        document.getElementById('addPKBtn').onclick = () => {
            const date = document.getElementById('pkDate').value;
            const hours = parseFloat(document.getElementById('pkHours').value);
            const note = document.getElementById('pkNote').value;
            
            if (!date || !hours || hours <= 0) return alert('Unesi datum i PK sate!');
            
            db.ref(`vacation2/${currentUser}/pk`).push({
                date, hours, note, time: Date.now()
            }).then(() => {
                document.getElementById('pkDate').value = '';
                document.getElementById('pkHours').value = '';
                document.getElementById('pkNote').value = '';
            });
        };

        // ADD EARNED
        document.getElementById('addEarnedBtn').onclick = () => {
            const date = document.getElementById('earnedDate').value;
            const type = document.getElementById('earnedType').value;
            const days = parseFloat(document.getElementById('earnedDays').value);
            const note = document.getElementById('earnedNote').value;
            
            if (!date || !days || days <= 0) return alert('Unesi datum i dane!');
            
            db.ref(`vacation2/${currentUser}/earned`).push({
                date, type, days, remaining: days, note, time: Date.now()
            }).then(() => {
                document.getElementById('earnedDate').value = '';
                document.getElementById('earnedDays').value = '';
                document.getElementById('earnedNote').value = '';
            });
        };

        // ADD USED
        document.getElementById('addUseBtn').onclick = () => {
            const from = document.getElementById('useFrom').value;
            const to = document.getElementById('useTo').value;
            const days = parseFloat(document.getElementById('useDays').value);
            const sourceId = useSource.value;
            
            if (!from || !to || !days || !sourceId) return alert('Popuni sva polja!');
            
            const source = earnedData[sourceId];
            if (days > (source.remaining || 0)) {
                return alert(`Nema≈° dovoljno! Preostalo: ${(source.remaining || 0).toFixed(2)} dana`);
            }
            
            // Smanji remaining
            db.ref(`vacation2/${currentUser}/earned/${sourceId}/remaining`).transaction(
                x => Math.max(0, parseFloat(x || source.days || 0) - days)
            );
            
            // Dodaj used
            db.ref(`vacation2/${currentUser}/used`).push({
                from, to, days, source: useSource.selectedOptions[0].text, time: Date.now()
            }).then(() => {
                document.getElementById('useFrom').value = '';
                document.getElementById('useTo').value = '';
                document.getElementById('useDays').value = '';
            });
        };
    </script>
</body>
</html>
