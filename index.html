<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Slobodni dani i prekovremeni</title>

  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --danger: #ef4444;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 10px 25px rgba(15,23,42,0.12);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e5edff 0, var(--bg) 50%, #e5e7eb 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--text);
    }
    .container { max-width: 1100px; margin: 0 auto; }
    .card {
      background: var(--card);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 24px;
      margin-top: 24px;
    }
    .login-card {
      max-width: 360px;
      margin: 90px auto 0;
      text-align: center;
    }
    h1 { font-size: 1.6rem; margin-bottom: 6px; color: var(--primary); }
    h2 { font-size: 1.3rem; margin-bottom: 10px; color: var(--primary); }
    h3 { font-size: 1.05rem; margin-bottom: 8px; }
    p.muted { color: var(--muted); font-size: 0.9rem; }

    .form-group { margin-bottom: 12px; }
    label { display: block; margin-bottom: 4px; font-size: 0.85rem; color: var(--muted); }
    input, select, textarea {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 0.95rem;
      background: #f9fafb;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37,99,235,0.25);
    }
    textarea { resize: vertical; min-height: 60px; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      transition: background 0.2s, transform 0.1s;
    }
    .btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
    .btn-danger { background: var(--danger); }
    .btn-danger:hover { background: #b91c1c; }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 16px;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
    }
    @media (max-width: 768px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 14px;
      margin-bottom: 18px;
    }
    .stat {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      border-radius: 16px;
      padding: 14px 16px;
    }
    .stat-label { font-size: 0.8rem; opacity: 0.9; }
    .stat-value { font-size: 1.5rem; font-weight: 700; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.9rem;
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      background: #f9fafb;
      text-align: left;
    }
    th {
      background: #1f2937;
      color: #f9fafb;
      font-weight: 600;
    }
    tr:hover td { background: #eef2ff; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge-ok { background: #dcfce7; color: #166534; }
    .badge-low { background: #fee2e2; color: #991b1b; }

    .header-flex {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }
  </style>
</head>
<body>
<div class="container">

  <!-- LOGIN -->
  <div id="loginCard" class="card login-card">
    <h1>Slobodni dani & prekovremeni</h1>
    <p class="muted" style="margin-bottom:18px;">Unesi korisničko ime (bez lozinke)</p>
    <div class="form-group">
      <label>Korisničko ime</label>
      <input id="loginName" type="text" placeholder="npr. marko" />
    </div>
    <button id="loginBtn" class="btn">Ulogiraj se</button>
  </div>

  <!-- APP -->
  <div id="appCard" class="card" style="display:none;">
    <div class="header-flex">
      <div>
        <h1>Tvoja evidencija</h1>
        <p class="muted">Prijavljen kao: <span id="userLabel"></span></p>
      </div>
      <button id="logoutBtn" class="btn btn-danger">Odjava</button>
    </div>

    <!-- SALDO -->
    <div class="stats">
      <div class="stat">
        <div class="stat-label">Preostalo ukupno dana</div>
        <div class="stat-value" id="statTotalDays">0.00</div>
      </div>
      <div class="stat">
        <div class="stat-label">Ukupno PK sati (sve aktivnosti)</div>
        <div class="stat-value" id="statTotalPk">0.0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Slobodnih sati iz PK (×1.6)</div>
        <div class="stat-value" id="statFreeHours">0.0</div>
      </div>
    </div>

    <!-- ZARAĐENO (dani + PK u JEDNOM REDU) -->
    <div style="margin-bottom:22px;">
      <h2>Zarađeno (po aktivnosti)</h2>
      <p class="muted" style="margin-bottom:10px;">
        U jednom retku upišeš koliko je direktnih dana + koliko PK sati na toj aktivnosti.
        Svaki PK sat vrijedi 1.6 slobodnih sati, a svakih 8 sati = 1 dan.
      </p>
      <div class="grid-3">
        <div class="form-group">
          <label>Datum</label>
          <input type="date" id="earnDate">
        </div>
        <div class="form-group">
          <label>Aktivnost / opis</label>
          <input type="text" id="earnActivity" placeholder="npr. Projekt X, subota...">
        </div>
        <div class="form-group">
          <label>Direktni dani (1, 2... može 0)</label>
          <input type="number" id="earnBaseDays" step="0.1" value="0">
        </div>
        <div class="form-group">
          <label>PK sati na toj aktivnosti</label>
          <input type="number" id="earnPkHours" step="0.1" value="0">
        </div>
        <div class="form-group">
          <label>Napomena</label>
          <input type="text" id="earnNote" placeholder="nije obavezno">
        </div>
        <div class="form-group" style="align-self:end;">
          <button id="addEarnBtn" class="btn" style="width:100%;">Dodaj zarađeno</button>
        </div>
      </div>
    </div>

    <!-- KORIŠTENJE -->
    <div style="margin-bottom:22px;">
      <h2>Korištenje dana</h2>
      <div class="grid-3">
        <div class="form-group">
          <label>Od datuma</label>
          <input type="date" id="useFrom">
        </div>
        <div class="form-group">
          <label>Do datuma</label>
          <input type="date" id="useTo">
        </div>
        <div class="form-group">
          <label>Broj dana</label>
          <input type="number" id="useDays" step="0.1">
        </div>
        <div class="form-group">
          <label>Iz kojeg unosa</label>
          <select id="useSource">
            <option value="">Odaberi...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Razlog / napomena</label>
          <input type="text" id="useNote" placeholder="godišnji, slobodan dan...">
        </div>
        <div class="form-group" style="align-self:end;">
          <button id="addUseBtn" class="btn" style="width:100%;" disabled>Dodaj korištenje</button>
        </div>
      </div>
    </div>

    <!-- TABLICE -->
    <div class="grid-2">
      <div>
        <h3>Zarađeno po aktivnostima</h3>
        <table>
          <thead>
          <tr>
            <th>Datum</th>
            <th>Aktivnost</th>
            <th>Dani</th>
            <th>PK sati</th>
            <th>Ukupno dana</th>
            <th>Preostalo</th>
          </tr>
          </thead>
          <tbody id="earnedTableBody"></tbody>
        </table>
      </div>
      <div>
        <h3>Korištenje</h3>
        <table>
          <thead>
          <tr>
            <th>Od–do</th>
            <th>Dani</th>
            <th>Iz unosa</th>
          </tr>
          </thead>
          <tbody id="usedTableBody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
  // Firebase config – isti projekt koji već koristiš
  const firebaseConfig = {
    apiKey: "AIzaSyAwqBgH3OOfC74k21fln-xd5Q1E6w2gptY",
    authDomain: "drzava-grad-selo-8d986.firebaseapp.com",
    databaseURL: "https://drzava-grad-selo-8d986-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "drzava-grad-selo-8d986",
    storageBucket: "drzava-grad-selo-8d986.firebasestorage.app",
    messagingSenderId: "499006072662",
    appId: "1:499006072662:web:3001f6700f0268df1b58f7"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database(); // [web:34][web:61]

  const PK_FACTOR = 1.6;
  const HOURS_PER_DAY = 8;

  // DOM
  const loginCard   = document.getElementById('loginCard');
  const appCard     = document.getElementById('appCard');
  const loginName   = document.getElementById('loginName');
  const loginBtn    = document.getElementById('loginBtn');
  const logoutBtn   = document.getElementById('logoutBtn');
  const userLabel   = document.getElementById('userLabel');

  const statTotalDays  = document.getElementById('statTotalDays');
  const statTotalPk    = document.getElementById('statTotalPk');
  const statFreeHours  = document.getElementById('statFreeHours');

  const earnDate      = document.getElementById('earnDate');
  const earnActivity  = document.getElementById('earnActivity');
  const earnBaseDays  = document.getElementById('earnBaseDays');
  const earnPkHours   = document.getElementById('earnPkHours');
  const earnNote      = document.getElementById('earnNote');
  const addEarnBtn    = document.getElementById('addEarnBtn');

  const useFrom   = document.getElementById('useFrom');
  const useTo     = document.getElementById('useTo');
  const useDays   = document.getElementById('useDays');
  const useSource = document.getElementById('useSource');
  const useNote   = document.getElementById('useNote');
  const addUseBtn = document.getElementById('addUseBtn');

  const earnedTableBody = document.getElementById('earnedTableBody');
  const usedTableBody   = document.getElementById('usedTableBody');

  let currentUser = null;
  let earnedCache = {};

  // LOGIN
  loginBtn.addEventListener('click', () => {
    const name = loginName.value.trim().toLowerCase();
    if (!name) { alert('Upiši korisničko ime.'); return; }

    loginBtn.disabled = true;
    db.ref('vacation3/users/' + name).set({
      username: name,
      createdAt: Date.now()
    }).then(() => {
      currentUser = name;
      localStorage.setItem('vac3_user', name);
      showApp();
    }).catch(err => {
      console.error(err);
      alert('Greška pri spajanju na bazu.');
      loginBtn.disabled = false;
    });
  });

  // auto login
  const saved = localStorage.getItem('vac3_user');
  if (saved) {
    currentUser = saved;
    showApp();
  }

  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('vac3_user');
    location.reload();
  });

  function showApp() {
    userLabel.textContent = currentUser;
    loginCard.style.display = 'none';
    appCard.style.display = 'block';
    subscribeData();
  }

  // Pretvori broj sigurno na 2 decimale
  function to2(n) {
    return Math.round((Number(n) || 0) * 100) / 100;
  }

  // SLUŠANJE PODATAKA
  function subscribeData() {
    const basePath = 'vacation3/' + currentUser;

    // Zarađeno
    db.ref(basePath + '/earned').on('value', snap => {
      earnedTableBody.innerHTML = '';
      useSource.innerHTML = '<option value="">Odaberi...</option>';
      earnedCache = {};

      let totalRemaining = 0;
      let totalPkAll = 0;

      snap.forEach(child => {
        const id = child.key;
        const data = child.val() || {};
        earnedCache[id] = data;

        const baseDays = Number(data.baseDays || 0);
        const pkHours  = Number(data.pkHours || 0);
        const totalDays = Number(data.totalDays || 0);
        const remaining = Number(data.remaining || 0);

        totalRemaining += remaining;
        totalPkAll += pkHours;

        const tr = document.createElement('tr');
        const badgeClass = remaining > 0 ? 'badge-ok' : 'badge-low';

        tr.innerHTML = `
          <td>${data.date || ''}</td>
          <td>${data.activity || ''}</td>
          <td>${to2(baseDays)}</td>
          <td>${to2(pkHours)}</td>
          <td>${to2(totalDays)}</td>
          <td><span class="badge ${badgeClass}">${to2(remaining)}</span></td>
        `;
        earnedTableBody.appendChild(tr);

        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = `${data.date || ''} – ${data.activity || ''} (${to2(remaining)} dana ostalo)`;
        useSource.appendChild(opt);
      });

      const freeHours = totalPkAll * PK_FACTOR;
      statTotalDays.textContent = to2(totalRemaining).toFixed(2);
      statTotalPk.textContent   = to2(totalPkAll).toFixed(1);
      statFreeHours.textContent = to2(freeHours).toFixed(1);

      addUseBtn.disabled = Object.keys(earnedCache).length === 0;
    });

    // Korištenje
    db.ref(basePath + '/used').on('value', snap => {
      usedTableBody.innerHTML = '';
      snap.forEach(child => {
        const d = child.val() || {};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.fromDate || ''} – ${d.toDate || ''}</td>
          <td>${to2(d.days).toFixed(2)}</td>
          <td>${d.sourceLabel || ''}</td>
        `;
        usedTableBody.appendChild(tr);
      });
    });
  }

  // DODAJ ZARAĐENO (jedan red = dani + PK)
  addEarnBtn.addEventListener('click', () => {
    if (!currentUser) { alert('Prijavi se.'); return; }

    const date      = earnDate.value;
    const activity  = earnActivity.value.trim();
    const baseDays  = Number(earnBaseDays.value || 0);
    const pkHours   = Number(earnPkHours.value || 0);
    const note      = earnNote.value.trim();

    if (!date) { alert('Odaberi datum.'); return; }
    if (baseDays <= 0 && pkHours <= 0) {
      alert('Unesi barem direktne dane ili PK sate.');
      return;
    }

    // izračun: ukupni dani = direktni + (PK * 1.6 / 8)
    const extraDaysFromPk = pkHours * PK_FACTOR / HOURS_PER_DAY;
    const totalDays = baseDays + extraDaysFromPk;

    const ref = db.ref('vacation3/' + currentUser + '/earned').push();
    ref.set({
      date,
      activity,
      baseDays: to2(baseDays),
      pkHours: to2(pkHours),
      totalDays: to2(totalDays),
      remaining: to2(totalDays),
      note,
      createdAt: Date.now()
    }).then(() => {
      earnBaseDays.value = '0';
      earnPkHours.value  = '0';
      earnNote.value     = '';
    }).catch(err => {
      console.error(err);
      alert('Greška pri spremanju.');
    });
  });

  // DODAJ KORIŠTENJE
  addUseBtn.addEventListener('click', () => {
    if (!currentUser) { alert('Prijavi se.'); return; }

    const fromDate = useFrom.value;
    const toDate   = useTo.value;
    const days     = Number(useDays.value || 0);
    const sourceId = useSource.value;
    const note     = useNote.value.trim();

    if (!fromDate || !toDate || days <= 0 || !sourceId) {
      alert('Popuni sva polja za korištenje.');
      return;
    }

    const src = earnedCache[sourceId];
    if (!src) { alert('Odabrani unos više ne postoji.'); return; }

    const remaining = Number(src.remaining || src.totalDays || 0);
    if (days > remaining) {
      if (!confirm(`Na tom unosu ima samo ${to2(remaining)} dana. Svejedno koristiti ${to2(days)}?`)) {
        return;
      }
    }

    // smanji remaining transakcijom
    const remRef = db.ref('vacation3/' + currentUser + '/earned/' + sourceId + '/remaining');
    remRef.transaction(curr => {
      const cur = Number(curr || src.totalDays || 0);
      const next = cur - days;
      return next < 0 ? 0 : to2(next);
    });

    // upiši korištenje
    const usedRef = db.ref('vacation3/' + currentUser + '/used').push();
    usedRef.set({
      fromDate,
      toDate,
      days: to2(days),
      sourceId,
      sourceLabel: useSource.options[useSource.selectedIndex].text,
      note,
      createdAt: Date.now()
    }).then(() => {
      useFrom.value = '';
      useTo.value   = '';
      useDays.value = '';
      useNote.value = '';
    }).catch(err => {
      console.error(err);
      alert('Greška pri spremanju korištenja.');
    });
  });
</script>
</body>
</html>
